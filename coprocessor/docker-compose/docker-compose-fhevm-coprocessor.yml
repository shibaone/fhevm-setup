services:
  fhevm-coprocessor-db:
    container_name: ${DOCKER_COMPOSE_PROJECT}-fhevm-coprocessor-db
    image: postgres:15.7
    restart: always
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
    ports:
      - '5432:5432'
    volumes:
      - fhevm_coprocessor_db:/var/lib/postgresql/data
  fhevm-coprocessor:
    container_name: ${DOCKER_COMPOSE_PROJECT}-fhevm-coprocessor
    image: ghcr.io/zama-ai/fhevm-coprocessor:v0.6.0-6
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@fhevm-coprocessor-db:5432/coprocessor
    ports:
      - '50055:50052'
    volumes:
      - ../coprocessor.key:/usr/share/coprocessor.key
    command:
      - --run-bg-worker
      - --run-server
      - --server-addr=0.0.0.0:50052
      - --coprocessor-private-key=/usr/share/coprocessor.key
  fhevm-geth:
    container_name: ${DOCKER_COMPOSE_PROJECT}-fhevm-geth
#    image: shib-devrollup-go-eth-fhe:latest
    image: shib-devrollup-go-eth-elder-fhe:latest
    entrypoint:
      - /bin/sh
      - -c
      - mkdir -p /logs && geth init --state.scheme=hash --datadir=datadir genesis.json && geth --ipcpath=/tmp/geth.ipc
    environment:
      - GETH_AUTHRPC_ADDR=0.0.0.0
      - GETH_AUTHRPC_JWTSECRET=/root/jwt.txt
      - GETH_AUTHRPC_PORT=8551
      - GETH_AUTHRPC_VHOSTS=*
      - GETH_DATADIR=/datadir
      - GETH_GCMODE=archive
      - GETH_HTTP=true
      - GETH_HTTP_ADDR=0.0.0.0
      - GETH_HTTP_API=web3,debug,eth,txpool,net,engine
      - GETH_HTTP_CORSDOMAIN=*
      - GETH_HTTP_PORT=8545
      - GETH_HTTP_VHOSTS=*
      - GETH_MAXPEERS=0
      - GETH_NETWORKID=67739
      - GETH_NODISCOVER=true
      - GETH_ROLLUP_DISABLETXPOOLGOSSIP=true
      - GETH_SYNCMODE=full
      - GETH_WS=true
      - GETH_WS_ADDR=0.0.0.0
      - GETH_WS_API=debug,eth,txpool,net,engine
      - GETH_WS_ORIGINS=*
      - GETH_WS_PORT=8546
      - FHEVM_COPROCESSOR_API_KEY=a1503fb6-d79b-4e9e-826d-44cf262f3e05
      - FHEVM_COPROCESSOR_URL=fhevm-coprocessor:50052
      - COPROCESSOR_CONTRACT_ADDRESS=0x596E6682c72946AF006B27C131793F2b62527A4b
      - ACL_CONTRACT_ADDRESS=0x339EcE85B9E11a3A3AA557582784a15d7F82AAf2
      - FHEVM_CIPHERTEXTS_DB=/datadir/fhevm_ciphertexts.sqlite
      - FHEVM_CONTRACT_ADDRESS=0x596E6682c72946AF006B27C131793F2b62527A4b
      - FORCE_TRANSIENT_STORAGE=true
      - GETH_ELDER_SEQ=true
      - GETH_ELDER_SEQ_URL=54.221.93.21:9090
      - GETH_ELDER_ROLL_ID=3
      - GETH_ELDER_ROLL_START_BLOCK=5
      - GETH_ELDER_EXECUTOR=0x5a50c560c6c2422fc8b52afa52a0ec865579913fce8fc06703330bd1d381c427
    env_file:
      - ../.env
    volumes:
      - type: bind
        source: ../op-geth
        target: /datadir
      - type: bind
        source: ../jwt.txt
        target: /root/jwt.txt
      - type: bind
        source: ../genesis.json
        target: /genesis.json
    ports:
      - '8745:8545'
      - '8746:8546'
      - '8551:8551'
  op-node:
    entrypoint:
      - op-node
    environment:
      OP_NODE_L1_BEACON_IGNORE: "true"
      OP_NODE_L1_ETH_RPC: https://puppynet.shibrpc.com
      OP_NODE_L1_HTTP_POLL_INTERVAL: 5s
      OP_NODE_L1_RPC_KIND: basic
      OP_NODE_L1_TRUST_RPC: "false"
      OP_NODE_L2_ENGINE_AUTH: /app/jwt.txt
      OP_NODE_L2_ENGINE_RPC: http://fhevm-geth:8551
      OP_NODE_P2P_DISABLE: "true"
      OP_NODE_ROLLUP_CONFIG: /app/rollup.json
      OP_NODE_RPC_ADDR: 0.0.0.0
      OP_NODE_RPC_ENABLE_ADMIN: "true"
      OP_NODE_RPC_PORT: "8547"
      OP_NODE_SEQUENCER_ENABLED: "true"
      OP_NODE_SEQUENCER_L1_CONFS: "5"
      OP_NODE_VERIFIER_L1_CONFS: "4"
    env_file:
      - ../.env
#    image: 623062962206.dkr.ecr.us-east-1.amazonaws.com/op-node:dev
    image: 623062962206.dkr.ecr.us-east-1.amazonaws.com/elder-op-node:dev
    ports:
      - target: 8547
        published: "8547"
        protocol: tcp
    restart: unless-stopped
    stop_grace_period: 5m0s
    volumes:
      - type: bind
        source: ../jwt.txt
        target: /app/jwt.txt
      - type: bind
        source: ../rollup.json
        target: /app/rollup.json
  op-batcher:
    depends_on:
      fhevm-geth:
        condition: service_started
        required: false
      op-node:
        condition: service_started
        required: false
    entrypoint:
      - op-batcher
    environment:
      OP_BATCHER_L1_ETH_RPC: https://puppynet.shibrpc.com
      OP_BATCHER_L2_ETH_RPC: http://fhevm-geth:8545
      OP_BATCHER_MAX_CHANNEL_DURATION: "1"
      OP_BATCHER_NUM_CONFIRMATIONS: "1"
      OP_BATCHER_POLL_INTERVAL: 1s
      OP_BATCHER_PRIVATE_KEY: 0x4b0a085d454838e3956ee3026ce071dccede638730bc0331d8e3bceb1366b841
      OP_BATCHER_RESUBMISSION_TIMEOUT: 30s
      OP_BATCHER_ROLLUP_RPC: http://op-node:8547
      OP_BATCHER_RPC_ADDR: 0.0.0.0
      OP_BATCHER_RPC_ENABLE_ADMIN: "true"
      OP_BATCHER_RPC_PORT: "8548"
      OP_BATCHER_SAFE_ABORT_NONCE_TOO_LOW_COUNT: "3"
      OP_BATCHER_SUB_SAFETY_MARGIN: "6"
    env_file:
      - ../.env
    image: us-docker.pkg.dev/oplabs-tools-artifacts/images/op-batcher:v1.9.0
    ports:
      - target: 8548
        published: "8548"
        protocol: tcp
      - target: 9091
        published: "9091"
        protocol: tcp
    restart: unless-stopped
    stop_grace_period: 5m0s
  op-proposer:
    depends_on:
      fhevm-geth:
        condition: service_started
        required: false
      op-node:
        condition: service_started
        required: false
    entrypoint:
      - op-proposer
    environment:
      OP_PROPOSER_L1_ETH_RPC: https://puppynet.shibrpc.com
      OP_PROPOSER_L2OO_ADDRESS: 0x5B4a756E1A6D8e634250804A3F5AFc11F3198636
      OP_PROPOSER_POLL_INTERVAL: 12s
      OP_PROPOSER_PRIVATE_KEY: 0x07c939ece03619d7bf585639faa1394893324c5b018bb4abd322615af3637717
      OP_PROPOSER_ROLLUP_RPC: http://op-node:8547
      OP_PROPOSER_RPC_PORT: "8560"
    env_file:
      - ../.env
    image: us-docker.pkg.dev/oplabs-tools-artifacts/images/op-proposer:v1.9.0
    ports:
      - target: 8560
        published: "8560"
        protocol: tcp
      - target: 9094
        published: "9094"
        protocol: tcp
    restart: unless-stopped
    stop_grace_period: 5m0s
volumes:
  fhevm_coprocessor_db:
    driver: local
